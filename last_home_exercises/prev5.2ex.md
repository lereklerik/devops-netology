# Домашнее задание к занятию "5.2. Системы управления виртуализацией"

## 1. Выберите подходящую систему управления виртуализацией для предложенного сценария. Детально опишите ваш выбор.

### Сценарии:
    1.   100 виртуальных машин на базе Linux и Windows, общие задачи, нет особых требований
         Преимущественно Windows based инфраструктура, требуется реализация программных балансировщиков нагрузки, 
         репликации данных и автоматизированного механизма создания резервных копий
    2.   Требуется наиболее производительное бесплатное opensource решение для виртуализации небольшой (20 серверов) 
         инфраструктуры Linux и Windows виртуальных машин
    3.   Необходимо бесплатное, максимально совместимое и производительное решение для виртуализации Windows инфраструктуры
    4.   Необходимо рабочее окружение для тестирование программного продукта на нескольких дистрибутивах Linux

| Сценарий| Система управления виртуализацией | Примечание              |
|:-------:|:---------------------------------:|:-----------------------:|
| 1       | Hyper-V или VMWare                | У VMWare нет ограничений по выбору операционной системы, высокий уровень безопасности. Hyper-V как наиболее подходящий для MS. Однако в первом случае требуются хорошие инженерные навыки, во втором - требования проще. Поэтому приоритет за Hyper-V |
| 2       | KVM                               | KVM позволяет работать с гостевыми хостами на разными ОС, он наиболее производителен (по сравнению с Xen) |
| 3       | Hyper-V                           | Специфичных требований не указано, значит бесплатная версия Hyper-V, как наиболее совместима с MS, должна подойти |
| 4       | KVM, Xen или AWS/Openstack        | Самое очевидное - это выбор открытых KVM, Xen для тестирования. Однако, если нет возможности использовать свое оборудования и есть возможность наладить тестирование в облачных решениях - вполне рабочий вариант выбрать именно их, не тратя физические ресурсы на установку и трудовые ресурсы на настройку систем KVM или Xen |


## 2. Опишите сценарий миграции с VMware vSphere на Hyper-V для Linux и Windows виртуальных машин. Детально опишите необходимые шаги для использования всех преимуществ Hyper-V для Windows.

* Первое, что хотелось бы отметить, что подготовка к миграции должна быть организованной:
  * Спроектировать и протестировать процедуру миграции на стенде;
  * Сформировать команду миграции, в которую должны входить технические специалисты и администраторы автоматизированных систем;
  * (Если требуется) Обучить команду миграции работе с инструментами и технологиями. Обучение должно также обязательно пройти на стенде;
  * Составить реестр объектов миграции;
  * Согласовать совместно с администраторами автоматизированных систем план-график миграции.

#### Удалось найти вариантов миграции с использованием ПО:

<details>
<summary>Про Программы и утилиты</summary>

* **Microsoft System Center Virtual Machine Manager (SCVMM).**
  1. SCVMM позволяет подключить серверы управления VMware vCenter и из единой консоли видеть все узлы виртуализации и все виртуальные машины, с возможностью создания, управления и конвертации машин.  
  2. Для добавления vCenter в VMM требуется учетная запись с полными правами на всю инфраструктуру VMware vSphere и локальными административными правами на vCenter.
  3. SCVMM мигрирует виртуальную машину в выключенном состоянии, копируя ее диск в формате VMDK на узел по протоколу HTTP и выполняя конвертацию в VHDX по окончании копирования
  4. С точки зрения требований к ресурсам, на целевом узле требуется выделение двойного объема дискового пространства от используемого виртуальной машиной: на копирование диска и его конвертацию. После конвертации копия исходного диска удаляется и используется одна копия виртуальных дисков.
  5. При миграции виртуальной машины средствами SCVMM исходная машина на стороне VMware выключается и остается там по окончании миграции, требуя ручного удаления, что дает возможность простого включения исходной виртуальной машины, как плана отмены миграции
* **Microsoft Virtual Machine Converter (MVMC)**
  1. MVMC является отдельным продуктом Microsoft для миграции машин с инфраструктуры VMware vSphere (либо физических серверов) на Hyper-V (либо Microsoft Azure).
  2. В разрезе делегирования прав для MVMC хватает минимальной роли, которую настроили для миграции средством VMM. Прав на vSphere узлах не требуется
  3. Во время миграции выключенная машина копируется, затем конвертируется
  4. MVMC требует двойной объем дискового пространства на время конвертации
  5. При миграции виртуальной машины средствами MVMC исходная машина на стороне VMware выключается и остается там по окончании миграции, требуя ручного удаления, что дает возможность простого включения оригинальной виртуальной машины как плана отмены миграции.
* **5nine Easy Converter**
  1. 5nine Easy Converter (далее 5nine) – это стороннее решение V2V. Поставляется в виде бесплатной и платной версий, где платная версия имеет возможность автоматизации. Преимуществом в сравнении с VMM/MVMC является поддержка виртуальных машин второго поколения, в которые он может конвертировать машины VMware vSphere, использующие режим загрузки UEFI
  2. В разрезе делегирования прав на стороне vCenter для 5nine хватает минимальной роли, которую настроили для миграции с помощью VMM. При миграции напрямую с VSphere требуются права суперпользователя (root) на узлах.
  3. Скорость миграции машин и время недоступности для 5nine сравнимо с MVMC при миграции с vCenter. Выключенная машина копируется, затем конвертируется
  4. Продукт 5nine требует двойной объем дискового пространства на время конвертации
  5. Задачи, выполняемые бесплатной версией 5nine, не автоматизируются. Для платной версии существует модуль PowerShell из четырех коммандлетов, позволяющий автоматизировать миграцию напрямую с vSphere. Данный модуль не поддерживает миграцию с vCenter, а так как, как правило, компании имеют сотни узлов vSphere, и виртуальные машины автоматически перемещаются между ними, это накладывает ограничения – машины нужно будет на стороне VMware предварительно мигрировать на отдельный узел, где отключена технология балансировки.
  6. При миграции виртуальной машины средствами 5nine исходная машина на стороне VMware удаляется. Для отмены миграции следует предварительно сделать клон машины (можно автоматизировать, но требует дисковых ресурсов) либо восстанавливать исходную виртуальную машину из резервной копии
* **Скриптовое решение на базе NFS, VMotion и бесплатных утилит.**
  1. На сервере Windows один из дисков предоставляется в общий доступ как по протоколу SMB (типовые общие папки Windows), так и по протоколу NFS (протокол общих дисков для ОС UNIX, поддерживаемый также VMware VSphere). 
  2. На стороне VMware vCenter общий том NFS добавляется как хранилище, и виртуальная машина переносится на него во включенном состоянии с помощью технологии vMotion. 
  3. После того как файлы машины окажутся на сервере Windows, машина выключается, и ее диск из формата VMDK мгновенно конвертируется сначала в VHD, а затем в VHDX с помощью изменения заголовков файлов виртуального диска утилитами VHDtool и VHDXtool. 
  4. Далее скриптами PowerShell для VMM создается целевая высокодоступная виртуальная машина на Hyper-V с параметрами, аналогичными исходной, к ней подключается полученный VHDX диск. 
  5. На виртуальный диск, еще в выключенном состоянии, устанавливаются компоненты интеграции. Виртуальная машина включается, требуется одна перезагрузка, виртуальная машина получает старый IP-адрес и готова к работе через несколько минут недоступности.
  6. С точки зрения делегирования прав на стороне vCenter требуется лишь два права – клонирование (создать копию для отмены миграции) и перемещение дисков на том NFS. Прав на vSphere не требуется
  7. Наиболее сложным вопросом для описанного решения является его поддержка. Так как для конвертации не используется ни один из продуктов Microsoft, проблемы с конвертацией формальной поддержки получить не могут. Однако, если по окончанию конвертации виртуального диска в формат VHDX, диск получился монтируемым, то созданная машина Hyper-V имеет стандартную поддержку Microsoft.
  8. Виртуальная машина переносится на Windows сервер во включенном состоянии без остановки служб. Конвертация виртуальной машины выполняется за несколько секунд. Время простоя равно времени двух перезагрузок операционной системы. 
  9. Дополнительного дискового пространства на процесс конвертации не требуется. 
  10. Решение полностью построено на скриптах, использует модуль PowerShell для VMM и PowerCLI от VMware, а также сторонние бесплатные утилиты nfsutil, vhdtool и vhdxtool. Все задачи можно автоматизировать
  11. При миграции виртуальной машины средствами Storage vMotion файлы исходной машины VMware переносятся на том NFS, где на месте конвертируются в другой формат. Копирования дисков не происходит ни на одном из этапов, поэтому копий исходной виртуальной машины не остается. Для отмены миграции следует предварительно сделать резервную копию виртуальной машины.
</details>

* Опишу два способа автоматизированной миграции

##### 1 Способ: Смена формата виртуальных жестких дисков

-- Он предполагает использование утилит VHDTool и VHDXTool для преобразования жестких дисков.

* Оператор миграции авторизуется на ВМ сервера миграции и запускает скрипт с указанием файла, содержащего список мигрируемых ВМ, в качестве параметра.
* Миграция и конвертация происходит с минимальным простоем виртуальных машины.
* Все ошибки пишутся в отдельный лог.
* В случае неудачной миграции и/или ошибок в её ходе, применяются процедуры восстановления машин из резервной копии и переходят к способу №2:

##### 2 Способ: Использование инструментов SCVMM для миграции

-- Автоматизированный этап, предполагает использование инструментов SCVMM.

* Отключение виртуальных машин, что увеличивает время простоя (однако точно гарантирует целостность данных при возврате к начальному состоянию виртуальных машин при возникновении ошибок)
* Оператор миграции авторизуется на ВМ сервера миграции и запускает скрипт с указанием файла, содержащего список мигрируемых ВМ, в качестве параметра.
* После завершения миграции операторы проверяют общее состояние виртуальных нагрузок:
  * запуск ВМ
  * загрузка ОС ВМ
  * сетевые настройки и сетевую связность
  * соответствие оборудованию ВМ до начала миграции

Любой из двух способов миграции при успехе должен заканчиваться проверкой работоспособности ВМ в соответствии с параметрами конкретной автоматизированной системы.



## 3. Опишите возможные проблемы и недостатки гетерогенной среды виртуализации (использования нескольких систем управления виртуализацией одновременно) и что необходимо сделать для минимизации этих рисков и проблем. Если бы у вас был бы выбор, то создавали ли вы бы гетерогенную среду или нет? Мотивируйте ваш ответ примерами.

* Хотелось бы отметить, что в целом у виртуализации есть недостатки:
  >При внедрении технологий виртуализации возрастает _сложность_ программно-аппаратных комплексов.
  > 
  >Это связано с необходимостью иметь либо программные «прослойки» (к примеру, VMware), либо аппаратные.
  > 
  >Появление дополнительного программного или аппаратного обеспечения требует **дополнительных затрат на сопровождение и поддержку**, а также способно вызвать **увеличение количества потенциальных точек отказа**
  > 
  >Дополнительные изменения могут **привести к снижению надежности всей системы и сложности отслеживания отказов.**
  > 
  >Системы виртуализации нельзя использовать с программно-аппаратными комплексами, обеспечивающими защиту от несанкционированного доступа.  

* Однако, если с аппаратной и программной частями все более-менее понятно, то очень важно решить еще один вопрос - организационный:
  >**Отсутствие каких-либо стандартов** использования тех или иных технологий виртуализации (и не только) приводит к тому, что эти решения либо **вообще не интегрируются (точнее, интегрируются, но ни одним из производителей не поддерживаются)**, либо требуют для интеграции **дополнительный слой нестандартных решений**, что приводит к _гетерогенности_ всей системы в целом.
  > 
  >А **гетерогенность**, в свою очередь, приводить к снижению надежности или к необходимости построения всей инфраструктуры на решениях от одного производителя для устранения проблем несовместимости.
 

* В **гетерогенных средах** каждой средой приходится управлять **собственным инструментом**. 
* Общего решения для всех не существует, и есть только один выход — механизм скриптов, что довольно сложно, трудоемко и может **значительно усложнить задачи управления и мониторинга.** 
* И в конечном итоге компании приходится **менять привычные схемы разделения ответственности** за оборудование и программное обеспечение.

#### Что необходимо сделать для минимазации таких рисков?

* По организационной части ответить несложно: 
  * Самое важное - компании необходимо определиться, какие задачи и системы могут быть запущены в виртуальных средах, как они должны взаимодействовать между собой.
  * На основании этого:
    > Сделать обзор на существующие системы виртуализации на рынке
    > 
    > Определить критерии для выбора виртуальных систем, учитывая, что они могут взаимодействовать с уже существующими виртуальными средами
    > 
    > Задокументировать анализ 
  * После согласования выбора систем виртуализации, разработать стандарты использования технологий виртуализации;
  * Описать матрицу ролей с указанием ответственности за тот или иной элемент виртуализации;
  * В идеале, конечно, распределить роли так, чтоб никто из ответственных в обиде не остался от увеличения работы =) Ну это о наболевшем...
  * Если вернуться ко второму пункту ДЗ, то в нем описано, как наиболее грамотно подойти к вопросам миграции. Возьмем за основу то, что каждое изменение, которое должно вноситься в существующую рабочую среду/систему должно быть регламентировано. Так мы подойдем к пункту о необходимости составить Регламент работ, в котором бы описывались этапы внесения изменений, поддержки, тестирования среды виртуализации и зависимых систем, а также восстановлению систем в случае сбоя.
  * В свою очередь, любой регламент, поддержка требует умения и навыков от сотрудников, закрепленных ответственными за такие системы. Отсюда возникает необходимость обучения сотрудников навыкам поддержки таких систем. В зависимости от уровня ответственности, обучение может различаться.

* По программной и аппаратной части
  * Достаточно проблематично без опыта писать об этом, но предположить, что необходимо:
    > Спроектировать взаимодействие виртуальных систем таким образом, чтоб снизить к минимуму возможность коллизий. Это касается не только сетевого или аппаратного уровней, но также работы с данными: если несколько систем имеют доступ к одной БД, то необходимо определить, в каком ритме системы могут получать изменения - синхронном, асинхронном, и как процесс обновления будет регламентирован
    > 
    > Обеспечить безопасность работы виртуальных сред, выделив им отдельный контур для работы. Тут я подразумеваю, что должны работать не только брендмауэры, но также должны быть разграничены группы пользователей, имеющих доступ к работе с виртуальной(ыми) средой(ами) и в ней(них) самой(их)
    > 
    > Настроить по расписанию резервное копирование систем, в свою очередь это потребует достаточного количества ресурсов и/или финансов, в зависимости от выбранной системы виртуализации
     

#### Создавали бы вы гетерогенную среду виртуализации?

* В нашем современном мире, скорее всего, мы уже не сможем долго оставаться в гомогенной структуре. 
* Первое - не каждое ПО способно подарить нам бесплатные или открытые инструменты для виртуализации. В то же время, не каждая система виртуализации будет отвечать нашим потребностям.
* На работе есть виртуальные машины, с докер-контейнерами, с настроенными внутренними системами, которые также смотрят в облачные сервисы. Но данный этап временный - после настройки необходимого ПО всё будет развернуто на железе.
* Однако, такие временные этапы использования гетерогенных систем необходимы для тестирования или отладки. Возможно для этого бы я их и использовала.